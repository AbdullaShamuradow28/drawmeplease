<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <title>ГРОЗА УНИТАЗОВ!!</title>
    <style>
        /* Ваши стили остаются без изменений... */
    </style>
</head>
<body>
    <div class="modal" id="modal" onclick="hideModal(event)">
        <div class="modal-content" onclick="event.stopPropagation();">
            <h2>Добавить описание</h2>
            <input type="text" id="titleInput" class="modal-input" placeholder="Название рисунка" required>
            <input type="text" id="authorInput" class="modal-input" placeholder="Автор" required>
            <button class="tool-btn" onclick="saveDrawing()">Сохранить</button>
            <button class="tool-btn" onclick="hideModal(event)">Закрыть</button>
        </div>
    </div>

    <div class="screen active" id="galleryScreen">
        <div class="container">
            <h1 style="margin: 15px; margin-top: 50px; font-weight: normal;">Наша галерея</h1>
            <div class="gallery" id="gallery"></div>
            <button class="tool-btn" onclick="clearAllDrawings()">Очистить галерею</button>
        </div>
        <button class="fab" onclick="showDrawScreen()">+</button>
    </div>

    <div class="screen" id="drawScreen">
        <div class="container">
            <h1 style="margin: 15px; margin-top: 50px; font-weight: normal;">Нарисуй шедевр, кчау</h1>
            <div class="canvas-wrapper">
                <canvas id="canvas"></canvas>
            </div>
            <div class="tools">
                <div class="color-picker">
                    <input type="color" id="color" value="#000000" onchange="setColor(this.value)">
                </div>
                <input type="range" id="size" min="1" max="50" value="5" title="Размер кисти" class="brush-size">
                <button class="tool-btn spec-btn" title="Очистить рисунок" onclick="clearCanvas()"><i class="fa fa-refresh"></i></button>
                <button class="tool-btn spec-btn" title="Ластик" onclick="toggleEraser()"><i class="fa fa-eraser"></i></button>
                <button class="tool-btn spec-btn" title="Сохранить" onclick="saveAndReturn()"><i class="fa fa-save"></i></button>
                <button class="tool-btn spec-btn" title="Отменить" onclick="undoLast()"><i class="fa fa-undo"></i></button>
                <button class="tool-btn spec-btn" title="Повторить" onclick="redoLast()"><i class="fa fa-redo"></i></button>
            </div>
        </div>
    </div>

    <script>
        // Canvas setup
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;
        let currentColor = '#000000';
        let brushSize = 5;
        let undoStack = [];
        let redoStack = [];

        // Resize canvas to fit the screen
        function resizeCanvas() {
            canvas.width = document.querySelector('.canvas-wrapper').clientWidth; // ширина родительского элемента
            canvas.height = 400; // фиксированная высота
        }

        // Set color on change
        function setColor(color) {
            currentColor = color;
        }

        // Brush size input handling
        document.getElementById('size').addEventListener('input', (e) => {
            brushSize = e.target.value;
        });

        // Mouse and touch event handling
        canvas.addEventListener('mousedown', (e) => { startDrawing(e); });
        canvas.addEventListener('mousemove', (e) => { draw(e); });
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseleave', stopDrawing);

        canvas.addEventListener('touchstart', (e) => { startDrawing(e); });
        canvas.addEventListener('touchmove', (e) => { drawTouch(e); });
        canvas.addEventListener('touchend', stopDrawing);

        // Start drawing
        function startDrawing(e) {
            isDrawing = true;
            saveState(); // Save state at the beginning of drawing
            ctx.beginPath();
            draw(e);
        }

        // Draw on canvas
        function draw(e) {
            if (!isDrawing) return;
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX || (e.touches && e.touches[0].clientX)) - rect.left; // Коррекция по позиции
            const y = (e.clientY || (e.touches && e.touches[0].clientY)) - rect.top;  // Коррекция по позиции
            ctx.lineTo(x, y);
            ctx.strokeStyle = currentColor;
            ctx.lineWidth = brushSize;
            ctx.lineCap = "round"; 
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(x, y);
        }

        function drawTouch(e) {
            e.preventDefault();
            draw(e);
        }

        // Stop drawing
        function stopDrawing() {
            if (!isDrawing) return;
            isDrawing = false;
            ctx.beginPath();
        }

        // Save canvas state for undo functionality
        function saveState() {
            undoStack.push(ctx.getImageData(0, 0, canvas.width, canvas.height));
            redoStack = [];
        }

        // Undo last action
        function undoLast() {
            if (undoStack.length === 0) return;
            redoStack.push(ctx.getImageData(0, 0, canvas.width, canvas.height));
            ctx.putImageData(undoStack.pop(), 0, 0);
        }

        // Redo last undone action
        function redoLast() {
            if (redoStack.length === 0) return;
            undoStack.push(ctx.getImageData(0, 0, canvas.width, canvas.height));
            ctx.putImageData(redoStack.pop(), 0, 0);
        }

        // Clear the canvas
        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            undoStack = [];
        }

        // Toggle eraser functionality
        function toggleEraser() {
            currentColor = (currentColor === '#FFFFFF') ? '#000000' : '#FFFFFF';
            document.getElementById('color').value = currentColor;
        }

        // Save current drawing
        function saveAndReturn() {
            const currentDataUrl = canvas.toDataURL();
            showModal(currentDataUrl);
        }

        // Show modal for drawing details
        function showModal(currentDataUrl) {
            document.getElementById('modal').style.display = 'block';
            document.getElementById('titleInput').value = '';
            document.getElementById('authorInput').value = '';
        }

        // Hide modal
        function hideModal(event) {
            document.getElementById('modal').style.display = 'none';
        }

        // Show drawing screen
        function showDrawScreen() {
            document.getElementById('drawScreen').classList.add('active');
            document.getElementById('galleryScreen').classList.remove('active');
            resizeCanvas();
        }

        // Save drawing to the server
        async function saveDrawing() {
            const title = document.getElementById('titleInput').value;
            const author = document.getElementById('authorInput').value;
            const currentDataUrl = canvas.toDataURL();

            if (!title || !author || !currentDataUrl) {
                alert('Заполните все поля и нарисуйте что-нибудь!');
                return;
            }

            const drawingData = {
                title,
                author,
                image: currentDataUrl,
            };

            // Sending data to the server
            const response = await fetch('https://abddie.pythonanywhere.com/drawings/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(drawingData)
            });

            if (response.ok) {
                hideModal();
                clearCanvas();
                await loadGallery(); // Загрузка галереи после сохранения
                showGallery();
            } else {
                alert('Ошибка сохранения рисунка');
            }
        }

        // Load gallery from the server
        async function loadGallery() {
            const galleryElement = document.getElementById('gallery');
            galleryElement.innerHTML = '';
            const response = await fetch('https://abddie.pythonanywhere.com/drawings/');
            if (!response.ok) {
                alert('Ошибка загрузки галереи');
                return; // Если есть ошибка загрузки, прекращаем выполнение
            }
            const savedDrawings = await response.json();

            // Проверка возвращаемых данных
            if (Array.isArray(savedDrawings) && savedDrawings.length > 0) {
                savedDrawings.forEach(drawing => {
                    const galleryItem = document.createElement('div');
                    galleryItem.className = 'gallery-item';
                    galleryItem.innerHTML = `
                        <img src="${drawing.image}" alt="${drawing.title}" loading="lazy">
                        <h2>${drawing.title}</h2>
                        <p>Автор: ${drawing.author}</p>
                        <p>Дата: ${drawing.date}</p>
                    `;
                    galleryElement.appendChild(galleryItem);
                });
            } else {
                const noDrawingsMessage = document.createElement('p');
                noDrawingsMessage.textContent = 'Нет доступных рисунков.';
                galleryElement.appendChild(noDrawingsMessage);
            }
        }

        // Show the gallery
        function showGallery() {
            document.getElementById('galleryScreen').classList.add('active');
            document.getElementById('drawScreen').classList.remove('active');
        }

        // Clear all saved drawings (Only for demonstration, needs adjustment if there's an endpoint)
        async function clearAllDrawings() {
            if (confirm('Вы уверены, что хотите очистить галерею?')) {
                // Законный DELETE должен быть создан на сервере для этого
                // await fetch('https://abddie.pythonanywhere.com/drawings/', { method: 'DELETE' });
                document.getElementById('gallery').innerHTML = ''; // очищаем только локально для простоты
            }
        }

        // Resize canvas on window resize
        window.addEventListener('resize', resizeCanvas);
        window.onload = function() {
            loadGallery(); // Загрузка галереи при загрузке страницы
            resizeCanvas();
        };
    </script>
</body>
</html>
